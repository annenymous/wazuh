---
name: decoder/dbsync/0

metadata:
    module: wazuh-agent/dbsync/dbsync
    title: DBSync Decoder
    description: >
        Decodes dbsync events
    compatibility: >
        This decoder has been tested on Wazuh version 4.3.9
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2022/11/08
    references:
        - https://github.com/wazuh/wazuh/issues/13521

sources:
  - decoder/queue-dbsync/0

check:
  - event.original: +s_starts/{

parse:
  logpar:
    - event.original: <~json/json>

normalize:
  - check:
      - ~json.type: +s_starts/integrity_check_
    map:
      - ~query: +s_concat/agent /$agent.id/ /$~json.component/ /$~json.type/ /$~json.data
      - ~query_response: +wdb_query/$~query
  - check:
      - ~query_response: +ef_exists
    map:
      - ~ar_query: +s_concat/(msg_to_agent) [] N!S /$agent.id/ /$~json.component/ dbsync /$~query_response/ /$~json.data
      - ~ar_result: +ar_send/$~ar_query

  - check:
      - ~json.type: +s_eq/state
    map:
      - ~query: +s_concat/agent /$agent.id/ /$~json.component/ save2 /$~json.data
      - ~query_status: +wdb_update/$~query

  - check:
      - ~json.type: +s_eq/integrity_clear
    map:
      - ~query: +s_concat/agent /$agent.id/ /$~json.component/ integrity_clear /$~json.data
      - ~query_status: +wdb_update/$~query
