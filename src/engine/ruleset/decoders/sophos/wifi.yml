---
name: decoder/sophos-wifi/0

metadata:
  module: sophos
  title: Sophos logs decoder
  description: Decoder for sophos logs
  author:
    name: Wazuh Inc. info@wazuh.com
    date: 2023-01-12
  references:
    - documentation link

check:
  - event.original: +r_match/<\d+>\s*device=.*?date=.*?time=.*?device_name=.*?device_id=.*?log_id=.*?log_type="Wireless Protection"

sources:
  - decoder/queue-syslog/0
  - decoder/queue-localfile/0

parse:
  logpar:
    # <30>device="SFW" date=2017-02-01 time=14:17:35 timezone="IST" device_name="SG115" device_id=S110016E28BA631 log_id=106025618011 log_type="Wireless Protection" log_component="Wireless Protection" log_subtype="Information" priority=Information ap=A40024A636F7862 ssid=SPIDIGO2015 clients_conn_SSID=2
    # <30>device="SFW" date=2017-02-01 time=14:19:47 timezone="IST" device_name="SG115" device_id=S110016E28BA631 log_id=106025618011 log_type="Wireless Protection" log_component="Wireless Protection" log_subtype="Information" priority=Information ap=A40024A636F7862 ssid=SPIDIGO2015 clients_conn_SSID=3
    - event.original: \<<~tmp.head_message>><~tmp.payload_messge>

normalize:
  - check:
      - ~tmp.payload_message: +ef_exists
    map:
      - ~tmp.payload_message: +s_replace/=""/=" "
    logpar:
      - ~tmp.payload_message: <~tmp/kv/=/ /"/'>
    map:
      - event.kind: event
      - event.module: sophos
      - event.dataset: sophos.xg
      - event.outcome: success
  - check:
      - ~tmp.priority: unknown
    map:
      - event.severity: 0
  - check:
      - ~tmp.priority: alert
    map:
      - event.severity: 1
  - check:
      - ~tmp.priority: critical
    map:
      - event.severity: 2
  - check:
      - ~tmp.priority: error
    map:
      - event.severity: 3
  - check:
      - ~tmp.priority: warning
    map:
      - event.severity: 4
  - check:
      - ~tmp.priority: notification
    map:
      - event.severity: 5
  - check:
      - ~tmp.priority: Information
    map:
      - event.severity: 6
  - map:
      # TODO: need converter timezone abbrevation to UTC offset, for example 'IST' to -02:00
      - event.timezone: $~tmp.timezone
      - fileset.name: xg
      - host.name: firewall.localgroup.local
      - input.type: log
      - \@timestamp: +s_concat/$~tmp.date/T/$~tmp.time
      - log.level: $~tmp.log_subtype
      - observer.product: XG
      - observer.serial_number: $~tmp.device_id
      - observer.type: firewall
      - observer.vendor: Sophos
      - sophos.xg.log_id: $~tmp.log_id
      - sophos.xg.device_name: $~tmp.device_name
      - sophos.xg.log_type: $~tmp.log_type
      - sophos.xg.log_component: $~tmp.log_type
      - sophos.xg.log_subtype: $~tmp.log_subtype
      - sophos.xg.priority: $~tmp.log_subtype
      - sophos.xg.ap: $~tmp.ap
      - sophos.xg.ssid: $~tmp.ssid
      - related.host: [$host.name]
      - tags: [forwarded, preserve_original_even, sophos-xg]
      - ~tmp: +ef_delete
