---
name: decoder/syscollector-dbsync-host-data/0

sources:
  - decoder/syscollector-dbsync-network-address-inserted/0
  - decoder/syscollector-dbsync-network-address/0
  - decoder/syscollector-dbsync-network-iface-inserted/0
  - decoder/syscollector-dbsync-network-iface/0
  - decoder/syscollector-dbsync-osinfo-inserted/0
  - decoder/syscollector-dbsync-osinfo/0

metadata:
    module: wazuh-agent/enrichment/syscollector-dbsync-host-data
    title: Host data from Syscollector DBSync events
    description: >
        Extracts host data from Syscollector DBSync events
    compatibility: >
        This decoder has been tested on Wazuh version 4.3
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2022/01/23

check:
  - ~do_update_kvdb: +t_is_true
  # TODO: Delete operation are not yet implemented
  - ~json.operation: +s_ne/DELETED

normalize:
  - check: +ef_exists/~json.data.hostname
    map:
      - ~kvdb_host.hostname: $~json.data.hostname
      - ~kvdb_host.name: $~json.data.hostname

  - check: +ef_exists/~json.data.architecture
    map:
      - ~kvdb_host.architecture: $~json.data.architecture

  - check: +ef_not_exists/~kvdb_host.network
    map:
      - ~kvdb_host.network: "{}"
      - ~kvdb_host.network: +parse_json/$~kvdb_host.network

  - check: +ef_exists/~json.data.mac AND +ef_exists/~json.data.name
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.name/":{"mac":"/$~json.data.mac/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.tx_packets AND +ef_exists/~json.data.name
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.name/":{"tx_packets":"/$~json.data.tx_packets/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.rx_packets AND +ef_exists/~json.data.name
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.name/":{"rx_packets":"/$~json.data.rx_packets/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.tx_bytes AND +ef_exists/~json.data.name
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.name/":{"tx_bytes":"/$~json.data.tx_bytes/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.rx_bytes AND +ef_exists/~json.data.name
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.name/":{"rx_bytes":"/$~json.data.rx_bytes/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.address AND +ef_exists/~json.data.iface AND +i_eq/~json.data.proto/0
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.iface/":{"ipv4":"/$~json.data.address/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - check: +ef_exists/~json.data.address AND +ef_exists/~json.data.iface AND +i_eq/~json.data.proto/1
    map:
      - ~host_aux: +s_concat/{"network":{"/$~json.data.iface/":{"ipv6":"/$~json.data.address/"/}}}
      - ~host_aux: +parse_json/$~host_aux
      - ~kvdb_host.network: +ef_merge_r/$~host_aux.network

  - map:
      - ~host_aux: +ef_delete