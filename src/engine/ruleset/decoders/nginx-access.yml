---
name: decoder/nginx-access/0

metadata:
  description: Parses nginx access logs
  references: "https://docs.nginx.com/nginx/admin-guide/monitoring/logging/#access_log"
  product.name: nginx
  product.versions:
    - nginx-1.23.2 #TODO: Check! for now only the latest version

sources:
  - decoder/nginx-access-base/0

check:
  - ~destination_address: +ef_exists

parse:
  logpar:
    # Quoted 3 IPs at beginning
    # "10.5.102.222, 175.16.199.1, 204.246.1.1" 10.2.1.185 - - [22/Jan/2016:13:18:29 +0000] "GET /assets/xxxx?q=100 HTTP/1.1" 200 25507 "-" "Amazon CloudFront"
    - ~destination_address: >-
         "<destination.ip>(?:<destination.port>), <~ip1/ip>(?,) <~ip2/ip>" <~ip3/ip>

    # More than 3 Ips
    # 1.128.3.4 2a02:cf40:10ff:f00f:0000:0000:0:8000, 10.225.192.17 10.2.2.121 - - [30/Dec/2016:06:47:09 +0000] "GET /test.html HTTP/1.1" 404 8571 "-" "Mozilla/5.0 (compatible; Facebot 1.0; https://developers.facebook.com/docs/sharing/webmasters/crawler)"
    - ~destination_address: >-
         <destination.ip>(?:<destination.port>) <~ip1/ip>(?,) <~ip2/ip>(?,) <~ip3/ip>

    # More than 3 Ips
    # TODO: almost duplicated from the previous one, double optional doesn't work when option doesnt' result
    # 1.128.3.4, 2a02:cf40:10ff:f00f:0000:0000:0:8000, 10.225.192.17 10.2.2.121 - - [30/Dec/2016:06:47:09 +0000] "GET /test.html HTTP/1.1" 404 8571 "-" "Mozilla/5.0 (compatible; Facebot 1.0; https://developers.facebook.com/docs/sharing/webmasters/crawler)"
    - ~destination_address: >-
         <destination.ip>(?:<destination.port>), <~ip1/ip>(?,) <~ip2/ip>(?,) <~ip3/ip>

    # 3 Ips
    # 10.0.0.2, 10.0.0.1, 127.0.0.1 - - [07/Dec/2016:11:05:07 +0100] "GET /ocelot HTTP/1.1" 200 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:49.0) Gecko/20100101 Firefox/49.0"
    # 10.0.0.2, 10.0.0.1, 81.2.69.143 - - [07/Dec/2016:11:05:07 +0100] "GET /ocelot HTTP/1.1" 200 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:49.0) Gecko/20100101 Firefox/49.0"
    # 2a02:cf40:10ff:f00f:0000:0000:0:8000, 10.225.192.17 10.2.2.121 - - [30/Dec/2016:06:47:09 +0000] "GET /test.html HTTP/1.1" 404 8571 "-" "Mozilla/5.0 (compatible; Facebot 1.0; https://developers.facebook.com/docs/sharing/webmasters/crawler)"
    - ~destination_address: >-
         <destination.ip>(?:<destination.port>), <~ip1/ip>(?,) <~ip2/ip>

    # Domain + 3 IPs
    # example.com 10.0.0.2, 10.0.0.1, 81.2.69.143 - - [07/Dec/2016:11:05:07 +0100] "GET /ocelot HTTP/1.1" 200 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:49.0) Gecko/20100101 Firefox/49.0"
    # TODO: can be duplicated due to not being able to add comma separator after first domain
    - ~destination_address: >-
        <~domain1/fqdn>(?:<destination.port>) <~ip1/ip>(?,) <~ip2/ip>(?,) <~ip3/ip>

    # 3 domains
    # example.com localhost, localhost - - [29/May/2017:19:02:48 +0000] "GET /test2 HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2" "-"
    - ~destination_address: >-
        <~domain1/fqdn>(?:<destination.port>) <~domain2/fqdn>(?,) <~domain3/fqdn>

    # 2 Ips
    # 1.128.3.4:80 127.0.0.1 - - [12/Apr/2018:09:48:40 +0200] "" 400 0 "-" "-"
    - ~destination_address: <?destination.ip>(?:<destination.port>) <~ip1/ip>

    # Domain + IP
    # lessons.example.com 192.168.0.1 - - [09/Jun/2020:12:10:39 -0700] "GET /A%20Beka%20G1%20Howe/029_AND_30/15%20reading%20elephants.mp4 HTTP/1.1" 206 7648063 "http://lessons.example.com/A%20Beka%20G1%20Howe/029_AND_30/15%20reading%20elephants.mp4" "Mozilla/5.0 (Linux; Android 5.1.1; KFFOWI) AppleWebKit/537.36 (KHTML, like Gecko) Silk/81.2.16 like Chrome/81.0.4044.138 Safari/537.36"
    # example.com:80 81.2.69.143 - - [07/Dec/2016:11:05:07 +0100] "GET /ocelot HTTP/1.1" 200 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"
    - ~destination_address: <~domain1/fqdn>(?:<destination.port>) <~ip1/ip>

    # IP + domain
    # 1.128.3.4 localhost - - [29/May/2017:19:02:48 +0000] "GET /test2 HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2" "-"
    - ~destination_address: <destination.ip>(?:<destination.port>) <~domain1/fqdn>

    # domain + domain
    # example.com:80 unix: - - [26/Feb/2019:15:39:42 +0100] "hello" 400 173 "-" "-"
    - ~destination_address: <~domain1/fqdn>(?:<destination.port>) <~domain2/fqdn>(?:)
    # localhost, localhost - - [29/May/2017:19:02:48 +0000] "GET /test2 HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2" "-"
    # TODO: almost duplicated from the previous one, double optional doesn't work when option doesnt' result
    - ~destination_address: <~domain1/fqdn>(?:<destination.port>), <~domain2/fqdn>

    # Single IP
    # 172.17.0.1 - - [29/May/2017:19:02:48 +0000] "GET /stringpatch HTTP/1.1" 404 612 "-" "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2" "-"
    # 81.2.69.143 - - [07/Dec/2016:11:05:07 +0100] "GET /ocelot HTTP/1.1" 200 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"
    # 127.0.0.1 - - [12/Apr/2018:09:48:40 +0200] "" 400 0 "-" "-"
    # 127.0.0.1 - - [07/Dec/2016:11:04:37 +0100] "GET /test1 HTTP/1.1" 404 571 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36"
    # 127.0.0.1 - - [07/Dec/2016:11:05:07 +0100] "GET /taga HTTP/1.1" 404 169 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:49.0) Gecko/20100101 Firefox/49.0"
    - ~destination_address: <destination.ip>(?:<destination.port>)

    # Single domain
    # localhost - - [29/May/2017:19:02:48 +0000] "GET /test2 HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20120716 Firefox/15.0a2" "-"
    # unix: - - [26/Feb/2019:15:39:42 +0100] "hello" 400 173 "-" "-"
    - ~destination_address: <~domain1/fqdn>(?:<?destination.port>)

normalize:
  - map:
      - $~domain1: +s_replace/"//
      - $~domain1: +s_replace/,//
      - $~domain2: +s_replace/"//
      - $~domain2: +s_replace/,//
      - destination.domain: $~domain1
      - url.domain: $~domain
      - source.address: $~ip1
      # TODO: a_append should try best case scenario (if not succeded then continue with the next?)
      # TODO: pending procedure
      # nginx.access.remote_ip_list will append if not private:
      # is private when firstByte 192 && seccondByte 168
      # ----------------firstByte 172 && seccondByte [16;31]
      # ----------------firstByte 172
      # if none of them is private > append first of the list
      - nginx.access.remote_ip_list: +a_append/$~domain1/~domain2
      - nginx.access.remote_ip_list: +a_append/$destination.ip/$~ip2/$~ip3/$~ip4

      - related.ip: +a_append/$destination.ip
      - related.ip: +a_append/$source.ip

      - event.kind: event
      - event.category: +a_append/web
      - event.type: +a_append/access

      - $~ip2: +ef_delete
      - $~ip3: +ef_delete
      - $~ip4: +ef_delete
      - $~domain1: +ef_delete
      - $~domain2: +ef_delete
      - $~domain3: +ef_delete
