---
name: decoder/nginx-access-base/0

metadata:
  description: Parses nginx access logs
  references: "https://docs.nginx.com/nginx/admin-guide/monitoring/logging/#access_log"
  product.name: nginx
  product.versions:
    - nginx-1.23.2 #TODO: Check! for now only the latest version

check:
  - event.original: +ef_exists

definitions:
  STATUS_W_BYTES: <http.response.status_code> <http.response.body.bytes>
  REFERRER: <~/literal/->?<http.request.referrer>
  USER_AGENT: <~/literal/->?<user_agent.original>

parse:
  logpar:

    - event.original: >-
        <~destination_address/text> - <~/literal/->?<user.name> [<@timestamp/%d\/%b\/%Y:%T %z>] <~request/quoted> $STATUS_W_BYTES "$REFERRER" "$USER_AGENT"

    - event.original: >-
        <~destination_address/text> - <~/literal/->?<user.name> [<@timestamp/%d\/%b\/%Y:%T %z>] <~request/quoted> $STATUS_W_BYTES "$REFERRER" "$USER_AGENT" "-"

normalize:
  -  map:
      - ~request_fields: "+s_to_array/$~request/ "
      - http.request.method: $~request_fields.0
      - url.original: $~request_fields.1
      # TODO: can be obtained from original -> shouldn't the parser do that?
      # - url.path:
      # - url.query:
      # - url.extension:
      - ~http_slash: 'HTTP/' #TODO: replace helper doesn't accept scaped char values
      - ~request_fields.2: +s_replace/$~http_slash//
      - http.version: $~request_fields.2
      - related.user: +a_append/$user.name
      - ~http_slash: +ef_delete

  - check:
      - http.response.status_code: +i_lt/400
    map:
      - event.outcome: success
  - check:
      - http.response.status_code: +i_ge/400
    map:
      - event.outcome: failure
